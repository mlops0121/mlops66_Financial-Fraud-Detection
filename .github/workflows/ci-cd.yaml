name: "CI/CD: Lint, Test and Build"

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    workflow_dispatch:

permissions:
    contents: read
    actions: read
    id-token: write

env:
  PROJECT_ID: machinelearningops66
  REGION: europe-west1
  SERVICE_NAME: fraud-detection-api
  GCP_BUCKET: databucketmlops66

jobs:
    changes:
        runs-on: ubuntu-latest
        outputs:
            api_logic: ${{ steps.filter.outputs.api_logic }}
            src_logic: ${{ steps.filter.outputs.src_logic }}

        steps:
         - uses: actions/checkout@v4
         - uses: dorny/paths-filter@v2
           id: filter
           with:
             filters: |
               api_logic:
                 - 'api/**'
                 - 'tests/test_api.py'
                 - '.github/workflows/api_tests.yaml'
                 - '**.py'
                 - 'Dockerfile'
                 - 'cloudbuild.yaml'

               src_logic:
                 - '.github/workflows/tests.yaml'
                 - 'src/**'
                 - 'tests/**'
                 - 'requirements_tests.txt'
                 - 'requirements.txt'
                 - '**.py'
               
               deploy_logic:
                 - 'api/**'
                 - 'src/**'
                 - 'Dockerfile'
                 - 'docker-entrypoint.sh'
                 - 'requirements.txt'
    Linting:
        needs: changes
        if: ${{ needs.changes.outputs.src_logic == 'true' || needs.changes.outputs.api_logic == 'true' }}
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v4
        
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: "3.10"
        
        - name: Install ruff
          run: pip install ruff mypy
        
        - name: Run ruff linting
          run: ruff check . --output-format=github
        
        - name: Run ruff format check
          run: ruff format --check .
          continue-on-error: true
        
        - name: Run mypy type checking
          run: mypy src/ --ignore-missing-imports --no-error-summary
          continue-on-error: true

    unit-tests:
        needs: [changes, Linting]
        if: ${{ needs.changes.outputs.src_logic == 'true' || needs.changes.outputs.api_logic == 'true' }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false #Continue running all jobs even if one fails.
            matrix:
                os: ["ubuntu-latest", "windows-latest", "macos-latest"] #Testing on multiple OS' to ensure cross-platform compatibility.
                python-version: ["3.11", "3.12", "3.13"] # Commonly used Python versions

        steps:
         - name: Checkout
           uses: actions/checkout@v5
         - name: Setup Python
           uses: actions/setup-python@v5
           with:
            python-version: ${{ matrix.python-version }}
            cache: "pip" #Caching pip dependencies between runs to speed up workflow.
        
         - name: Install dependencies
           run: |
            python -m pip install --upgrade pip
            pip install coverage pytest
            pip install -r requirements.txt
            pip install -r requirements_tests.txt
            pip list

         - name: Test with pytest
           run: |
            coverage run -m pytest tests/
            coverage xml -o coverage.xml
            coverage report -m --ignore-errors


         - name: Upload coverage to Codecov
           if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
           uses: codecov/codecov-action@v3
           with:
                files: ./coverage.xml
                flags: unittests
                name: codecov-umbrella
                fail_ci_if_error: true
        
    api-tests:
        needs: [changes, Linting]
        if: ${{ needs.changes.outputs.api_logic == 'true' }}
        runs-on: ubuntu-latest

        steps:
         - name: Checkout
           uses: actions/checkout@v4
         
         - name: Set up Python
           uses: actions/setup-python@v5
           with:
            python-version: "3.10"
        
         - name: Install dependencies
           run: |
            python -m pip install --upgrade pip
            pip install --extra-index-url https://download.pytorch.org/whl/cpu \
            torch torchvision torchaudio \
            -r requirements.txt \
            -r requirements_tests.txt

         - name: Run API tests
           run: |
                pytest tests/test_api.py -v --tb=short

    docker-build:
        needs: [changes, api-tests]
        runs-on: ubuntu-latest

        steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Free up disk space
           run: |
            docker system prune -af
            sudo rm -rf /usr/local/lib/python3.11/site-packages/*.dist-info
            sudo apt-get clean
            sudo rm -rf /var/lib/apt/lists/*
        
         - name: Build Docker image
           uses: docker/build-push-action@v5
           with:
            context: .
            push: false
            load: true  # Load image into local Docker daemon
            tags: fraud-detection-api:test
            cache-from: type=gha
            cache-to: type=gha,mode=max

         - name: Test Docker image starts
           run: |
                # Verify image was built
                docker images fraud-detection-api:test

                # Start container in background
                docker run -d --name test-api -p 8000:8000 fraud-detection-api:test

                # Wait for startup
                sleep 15

                # Check container status
                docker ps -a

                # Check logs
                docker logs test-api

                # Test health endpoint
                curl -f http://localhost:8000/ || echo "Health check failed (expected without model)"

                # Cleanup
                docker stop test-api || true
                docker rm test-api || true

    build-and-deploy:
        needs: [changes, Linting, unit-tests, docker-build, api-tests]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Authenticate to Google Cloud
            uses: google-github-actions/auth@v2
            with:
              credentials_json: ${{ secrets.GCP_SA_KEY }}

          - name: Set up Cloud SDK
            uses: google-github-actions/setup-gcloud@v2
            with:
              project_id: ${{ env.PROJECT_ID }}

          - name: Configure Docker for GCP
            run: |
              gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

          - name: Create Artifact Registry repository (if not exists)
            run: |
              gcloud artifacts repositories describe fraud-detection \
                --location=${{ env.REGION }} 2>/dev/null || \
              gcloud artifacts repositories create fraud-detection \
                --repository-format=docker \
                --location=${{ env.REGION }} \
                --description="Fraud Detection API images"

          - name: Build and push Docker image
            run: |
              IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/fraud-detection/api:${{ github.sha }}
              docker build -t $IMAGE .
              docker push $IMAGE
              echo "IMAGE=$IMAGE" >> $GITHUB_ENV

          - name: Deploy to Cloud Run
            run: |
              gcloud run deploy ${{ env.SERVICE_NAME }} \
                --image=${{ env.IMAGE }} \
                --region=${{ env.REGION }} \
                --platform=managed \
                --allow-unauthenticated \
                --set-env-vars="GCP_BUCKET=${{ env.GCP_BUCKET }}" \
                --memory=2Gi \
                --cpu=1 \
                --timeout=300 \
                --min-instances=0 \
                --max-instances=3

          - name: Get service URL
            run: |
              URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
                --region=${{ env.REGION }} \
                --format='value(status.url)')
              echo "## Deployed to Cloud Run" >> $GITHUB_STEP_SUMMARY
              echo "Service URL: $URL" >> $GITHUB_STEP_SUMMARY
              echo ""
              echo "=========================================="
              echo "Service deployed successfully!"
              echo "URL: $URL"
              echo "=========================================="
